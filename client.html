<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Chess Client</title>
    <meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #messages {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        #messageInput {
            width: 70%;
            padding: 10px;
        }
        #sendButton {
            width: 25%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .sent {
            background-color: #e3f2fd;
            text-align: right;
        }
        .received {
            background-color: #f5f5f5;
        }
        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .connected {
            background-color: #c8e6c9;
            color: #388e3c;
        }
        .disconnected {
            background-color: #ffcdd2;
            color: #d32f2f;
        }
    </style>
</head>
<body>
    <h1>WebSocket Chess Client</h1>
    
    <div id="status" class="status disconnected">Disconnected</div>
    
    <div id="messages"></div>
    
    <input type="text" id="messageInput" placeholder="Enter message..." disabled>
    <button id="sendButton" disabled>Send</button>
    <button id="connectButton">Connect</button>
    
    <p><small>提示：确保WebSocket服务器正在运行，并且端口8765已开放</small></p>
    
    <script>
        let socket;
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const connectButton = document.getElementById('connectButton');
        const statusDiv = document.getElementById('status');
        
        function addMessage(content, isSent) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            messageDiv.textContent = content;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function updateStatus(connected) {
            statusDiv.textContent = connected ? 'Connected' : 'Disconnected';
            statusDiv.className = `status ${connected ? 'connected' : 'disconnected'}`;
            messageInput.disabled = !connected;
            sendButton.disabled = !connected;
            connectButton.textContent = connected ? 'Disconnect' : 'Connect';
        }
        
        function connect() {
            // 优先使用环境变量中的WebSocket服务器地址，如果没有则使用PythonAnywhere域名
            const wsUrl = window.WEBSOCKET_SERVER || 'https://evsmcc.pythonanywhere.com';
            
            console.log('Connecting to WebSocket server:', wsUrl);
            
            // 配置Socket.IO连接，仅使用长轮询模式兼容PythonAnywhere
            socket = io(wsUrl, {
                transports: ['polling'], // 仅使用长轮询，禁用WebSocket
                upgrade: false, // 禁用协议升级
                timeout: 20000,
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });
            
            // 连接成功
            socket.on('connect', function() {
                console.log('Connected to server');
                if (document.getElementById('status')) {
                    document.getElementById('status').innerHTML = '<span style="color: green;">已连接</span>';
                }
                
                // 发送加入房间的消息
                socket.emit('join', {
                    roomId: parseInt(roomId),
                    name: name
                });
            });
            
            // 连接断开
            socket.on('disconnect', function() {
                console.log('Disconnected from server');
                if (document.getElementById('status')) {
                    document.getElementById('status').innerHTML = '<span style="color: red;">已断开</span>';
                }
            });
            
            // 连接错误
            socket.on('connect_error', function(error) {
                console.error('Connection error:', error);
                if (document.getElementById('status')) {
                    document.getElementById('status').innerHTML = '<span style="color: red;">连接错误</span>';
                }
            });
            
            // 监听聊天消息
            socket.on('chat', function(data) {
                console.log('Received chat message:', data);
                const messagesList = document.getElementById('messages');
                if (messagesList) {
                    const messageItem = document.createElement('li');
                    messageItem.textContent = `${data.name}: ${data.content}`;
                    messagesList.appendChild(messageItem);
                    messagesList.scrollTop = messagesList.scrollHeight;
                }
            });
            
            // 监听连接状态
            socket.on('status', function(data) {
                console.log('Status:', data.msg);
            });
        }
        
        function disconnect() {
            if (socket) {
                socket.disconnect();
            }
        }
        
        sendButton.addEventListener('click', function() {
            if (socket && socket.connected) {
                const message = messageInput.value;
                if (message.trim() !== '') {
                    socket.emit('message', message);
                    addMessage('Sent: ' + message, true);
                    messageInput.value = '';
                }
            }
        });
        
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });
        
        connectButton.addEventListener('click', function() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                disconnect();
            } else {
                connect();
            }
        });
    </script>
</body>
</html>